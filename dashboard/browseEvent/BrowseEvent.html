<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>UB Lipa Event Scheduler</title>
  <link rel="stylesheet" href="../css/style.css">
</head>
<body>

  <!-- HEADER -->
  <header class="topbar">
    <div class="logo-title">
      <img src="/IPT_UBEVENT/img/ublogo1.png" alt="UB Logo" class="logo">
      <span class="title">UB Lipa Event Scheduler</span>
    </div>
    <nav>
      <a href="../Home/home.html">Home</a>
      <a href="browseEvent.html">Browse Events</a>
      <a href="addEvents.html">Add Events</a>
      <button class="logout-btn" onclick="logoutUser()">Logout</button>
    </nav>
  </header>

  <!-- BROWSE EVENTS SECTION -->
  <section class="browse-events">
    <h2 class="section-title">Browse All Events</h2>

    <!-- Export and Import Options -->
    <div class="button-container">
      <button class="btn-import" onclick="window.location.href='http://127.0.0.1/IPT_UbEvent/auth/php/importEvents.php'">
        Import Events
      </button>

      <form method="POST" action="http://127.0.0.1/IPT_UbEvent/auth/php/exportEvents.php" class="export-form">
        <label for="format" class="export-label">Select Export Format:</label>
        <select name="format" id="format" class="export-dropdown">
          <option value="xml">XML</option>
          <option value="csv">CSV</option>
        </select>
        <button type="submit" class="btn-export">Export Events</button>
      </form>
    </div>
  </section>

  <!-- TABLE CONTAINER -->
  <div class="table-container">
    <div style="margin-bottom: 10px;">
      <label for="searchInput"><strong>Search Events:</strong></label>
      <input type="text" id="searchInput" placeholder="Search any column..." style="padding: 5px; width: 250px;">
    </div>

    <table id="eventTable">
      <thead>
        <tr>
          <th class="sortable" data-index="0"><span>Date</span> ▲▼</th>
          <th class="sortable" data-index="1"><span>Time</span> ▲▼</th>
          <th class="sortable" data-index="2"><span>Event Name</span> ▲▼</th>
          <th class="sortable" data-index="3"><span>Location</span> ▲▼</th>
          <th class="sortable" data-index="4"><span>Department</span> ▲▼</th>
          <th class="sortable" data-index="5"><span>Event Type</span> ▲▼</th>
          <th class="sortable" data-index="6"><span>Target Audience</span> ▲▼</th>
          <th class="sortable" data-index="7"><span>Registration Link</span> ▲▼</th>
          <th class="sortable" data-index="8"><span>Contact Information</span> ▲▼</th>
          <th class="sortable" data-index="9"><span>Agenda</span> ▲▼</th>
          <th>Actions</th>
        </tr>
      </thead>
      <tbody id="eventsList">
        <!-- Events will be dynamically added -->
      </tbody>
    </table>
  </div>

  <!-- FOOTER -->
  <footer class="footer">
    <p>© UB Lipa Info System</p>
  </footer>

  <script>
    const sortDirection = {};

    document.addEventListener("DOMContentLoaded", function () {
      const timestamp = new Date().getTime();
      fetch(`http://127.0.0.1/IPT_UbEvent/dashboard/data/event.xml?cache_buster=${timestamp}`)
        .then(response => response.text())
        .then(str => {
          const parser = new DOMParser();
          const xmlDoc = parser.parseFromString(str, "text/xml");
          const events = Array.from(xmlDoc.getElementsByTagName("event")).map(event => ({
            id: event.getElementsByTagName("id")[0]?.textContent || "",
            date: event.getElementsByTagName("date")[0]?.textContent || "",
            time: event.getElementsByTagName("time")[0]?.textContent || "",
            eventName: event.getElementsByTagName("eventName")[0]?.textContent || "",
            location: event.getElementsByTagName("location")[0]?.textContent || "",
            department: event.getElementsByTagName("department")[0]?.textContent || "",
            eventType: event.getElementsByTagName("eventType")[0]?.textContent || "",
            targetAudience: event.getElementsByTagName("targetAudience")[0]?.textContent || "",
            registrationLink: event.getElementsByTagName("registrationLink")[0]?.textContent || "",
            contactInformation: event.getElementsByTagName("contactInformation")[0]?.textContent || "",
            agenda: event.getElementsByTagName("agenda")[0]?.textContent || ""
          }));
          displayEvents(events);
        });

      function displayEvents(events) {
        const eventsList = document.getElementById("eventsList");
        eventsList.innerHTML = "";
        events.forEach((event, index) => {
          const row = document.createElement("tr");
          row.innerHTML = `
            <td>${event.date}</td>
            <td>${event.time}</td>
            <td>${event.eventName}</td>
            <td>${event.location}</td>
            <td>${event.department}</td>
            <td>${event.eventType}</td>
            <td>${event.targetAudience}</td>
            <td><a href="${event.registrationLink}" target="_blank">Register Here</a></td>
            <td>${event.contactInformation}</td>
            <td>${event.agenda}</td>
            <td><button>Edit</button> <button>Delete</button></td>
          `;
          eventsList.appendChild(row);
        });
        initSortableHeaders();
      }

      function initSortableHeaders() {
        document.querySelectorAll("th.sortable").forEach(th => {
          th.style.cursor = "pointer";
          th.addEventListener("click", () => {
            const index = parseInt(th.getAttribute("data-index"));
            sortTable(index, th);
          });
        });
      }

      function sortTable(colIndex, thElement) {
        const table = document.getElementById("eventTable");
        const tbody = table.tBodies[0];
        const rows = Array.from(tbody.rows);
        const isAsc = !(sortDirection[colIndex] = !sortDirection[colIndex]);

        rows.sort((a, b) => {
          let valA = a.cells[colIndex].textContent.trim();
          let valB = b.cells[colIndex].textContent.trim();

          if (colIndex === 0) {
            const timeA = a.cells[1].textContent.split('-')[0].trim();
            const timeB = b.cells[1].textContent.split('-')[0].trim();
            const fullA = new Date(`${valA} ${timeA}`);
            const fullB = new Date(`${valB} ${timeB}`);
            return isAsc ? fullA - fullB : fullB - fullA;
          }
          return isAsc
            ? valA.localeCompare(valB)
            : valB.localeCompare(valA);
        });

        rows.forEach(row => tbody.appendChild(row));

        const headers = thElement.parentElement.children;
        for (let i = 0; i < headers.length; i++) {
          if (i !== colIndex && headers[i].classList.contains("sortable")) {
            const span = headers[i].querySelector("span");
            if (span) headers[i].innerHTML = `<span>${span.textContent}</span> ▲▼`;
          }
        }

        const activeSpan = thElement.querySelector("span");
        if (activeSpan) {
          thElement.innerHTML = `<span>${activeSpan.textContent}</span> ${isAsc ? '▲' : '▼'}`;
        }
      }

      document.getElementById("searchInput").addEventListener("keyup", function () {
        const filter = this.value.toLowerCase();
        const rows = document.querySelectorAll("#eventTable tbody tr");
        rows.forEach(row => {
          const cells = Array.from(row.querySelectorAll("td")).slice(0, -1);
          const match = cells.some(cell => cell.textContent.toLowerCase().includes(filter));
          row.style.display = match ? "" : "none";
        });
      });
    });

    function logoutUser() {
      fetch("http://127.0.0.1/IPT_UbEvent/auth/php/logout.php")
        .then(() => window.location.href = "http://127.0.0.1/IPT_UbEvent/auth/login.html")
        .catch(err => alert("Logout failed."));
    }
  </script>

</body>
</html>
