<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>UB Lipa Event Scheduler - Home</title>
  <link rel="stylesheet" href="../css/style.css" />
</head>
<body>

  <!-- HEADER -->
  <header class="topbar">
    <div class="logo-title">
      <img src="../../img/ublogo1.png" alt="UB Logo" class="logo">
      <span class="title">UB Lipa Event Scheduler</span>
    </div>
    <nav>
      <a href="../Home/home.html">Home</a>
      <a href="../browseEvent/browseEvent.html">Browse Events</a>
      <a href="../browseEvent/addEvents.html">Add Events</a>
      <button class="logout-btn" onclick="logoutUser()">Logout</button>
    </nav>
  </header>

  <!-- MAIN SECTION -->
  <main class="home-wrapper">
    <h2 class="home-heading">Welcome to UB Lipa Event Scheduler</h2>
    <div class="welcomeText">
      <p>Welcome, <span id="userDisplay">Guest</span>!</p>
    </div>
  </main>

  <!-- UPCOMING EVENTS PANEL -->
  <main class="dashboard-wrapper">
    <!-- Left: Upcoming Events -->
    <section class="upcoming-panel">
      <h2 class="upcoming-title">Upcoming events</h2>
      <p class="upcoming-sub">Don't miss scheduled events</p>
      <div id="upcomingEventsContainer" class="event-list"></div>
    </section>

    <!-- Right: Calendar -->
    <section class="calendar-panel">
      <h2 class="calendar-title">Calendar</h2>
      <div id="calendar-nav">
        <button id="prevMonth">Previous</button>
        <span id="calendarMonth"></span>
        <button id="nextMonth">Next</button>
      </div>
      <div id="calendar" class="calendar-grid"></div>
    </section>
  </main>

  <!-- FOOTER -->
  <footer class="footer">
    <p>Â© UB Lipa Info System</p>
  </footer>

  <script>
    document.addEventListener("DOMContentLoaded", function () {
      let currentMonth = new Date().getMonth();
      let currentYear = new Date().getFullYear();

      const upcomingContainer = document.getElementById("upcomingEventsContainer");
      const calendarContainer = document.getElementById("calendar");
      const calendarMonth = document.getElementById("calendarMonth");
      const events = [];

      fetch("http://127.0.0.1/IPT_UbEvent/auth/php/getUserInfo.php")
        .then(res => res.json())
        .then(data => {
          if (data?.first_name && data?.last_name) {
            document.getElementById("userDisplay").textContent = `${data.first_name} ${data.last_name}`;
          }
        });

      fetchEventsAndUpdateCalendar();

      function fetchEventsAndUpdateCalendar() {
        fetch("http://127.0.0.1/IPT_UbEvent/dashboard/data/event.xml")
          .then(res => res.text())
          .then(str => {
            const xmlDoc = new DOMParser().parseFromString(str, "text/xml");
            const eventData = Array.from(xmlDoc.getElementsByTagName("event")).map(ev => ({
              date: ev.getElementsByTagName("date")[0]?.textContent || "",
              time: ev.getElementsByTagName("time")[0]?.textContent || "",
              name: ev.getElementsByTagName("eventName")[0]?.textContent || "",
              location: ev.getElementsByTagName("location")[0]?.textContent || " ",
            }));

            events.push(...eventData);

            const upcoming = eventData.filter(e => {
              const eventDate = new Date(e.date);
              const today = new Date();
              const startOfWeek = new Date(today);
              startOfWeek.setDate(today.getDate() - today.getDay());
              const endOfWeek = new Date(startOfWeek);
              endOfWeek.setDate(startOfWeek.getDate() + 6);

              return eventDate >= startOfWeek && eventDate <= endOfWeek;
            });

            if (upcoming.length === 0) {
              upcomingContainer.innerHTML = "<p>No upcoming events this week.</p>";
            } else {
              upcoming.forEach(e => {
                const date = new Date(e.date).toLocaleDateString("en-US", { month: "short", day: "numeric", year: "numeric" });
                const div = document.createElement("div");
                div.className = "event-card";
                div.innerHTML = `
                  <div class="event-date">ğŸ—•ï¸ ${date}</div>
                  <div class="event-time">ğŸ•’ ${e.time}</div>
                  <div class="event-title">ğŸ“Œ ${e.name}</div>
                  <div class="event-location">ğŸ“ ${e.location}</div>
                `;
                upcomingContainer.appendChild(div);
              });
            }

            drawCalendar(eventData);
          });
      }

      function drawCalendar(eventData) {
        const first = new Date(currentYear, currentMonth, 1);
        const last = new Date(currentYear, currentMonth + 1, 0);
        const totalDays = last.getDate();
        const startDay = first.getDay();

        const calendarDays = [];

        for (let i = 0; i < startDay; i++) {
          calendarDays.push(`<div class="day"></div>`);
        }

        for (let i = 1; i <= totalDays; i++) {
          const dateStr = `${currentYear}-${String(currentMonth + 1).padStart(2, '0')}-${String(i).padStart(2, '0')}`;
          const dayEvents = eventData.filter(e => e.date === dateStr);
          const eventHTML = dayEvents.map(ev => `<div class="event">${ev.name}</div>`).join("");

          calendarDays.push(`
            <div class="day">
              <div class="date">${i}</div>
              <div class="events-container">${eventHTML}</div>
            </div>
          `);
        }

        calendarContainer.innerHTML = calendarDays.join("");
        calendarMonth.textContent = new Date(currentYear, currentMonth).toLocaleDateString("en-US", { month: "long", year: "numeric" });
      }

      document.getElementById("prevMonth").addEventListener("click", function () {
        currentMonth = (currentMonth === 0) ? 11 : currentMonth - 1;
        currentYear = (currentMonth === 11) ? currentYear - 1 : currentYear;
        fetchEventsAndUpdateCalendar();
      });

      document.getElementById("nextMonth").addEventListener("click", function () {
        currentMonth = (currentMonth === 11) ? 0 : currentMonth + 1;
        currentYear = (currentMonth === 0) ? currentYear + 1 : currentYear;
        fetchEventsAndUpdateCalendar();
      });
    });

    function logoutUser() {
      fetch("http://127.0.0.1/IPT_UbEvent/auth/php/logout.php")
        .then(() => window.location.href = "http://127.0.0.1/IPT_UbEvent/auth/login.html")
        .catch(() => alert("Logout failed."));
    }
  </script>
</body>
</html>
